<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LiveCode Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.css">

  <style>
    :root {
      --primary-color: #4d6bff;
      --secondary-color: #3a56d5;
      --dark-bg: #1e1e1e;
      --darker-bg: #171717;
      --editor-bg: #2b2b2b;
      --border-color: #444;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--dark-bg);
      color: #fff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }
    
    h2 {
      margin: 0;
      color: #fff;
      font-size: 1.8rem;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .editor {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }
    
    .codebox {
      flex: 1;
      min-width: 300px;
      background: var(--darker-bg);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .codebox-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.2);
      border-bottom: 1px solid var(--border-color);
    }
    
    .codebox-title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .CodeMirror {
      height: 300px;
      background: var(--editor-bg);
      font-size: 14px;
      line-height: 1.5;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: var(--primary-color);
      color: white;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }
    
    button:hover {
      background-color: var(--secondary-color);
      transform: translateY(-1px);
    }
    
    button.secondary {
      background-color: #444;
    }
    
    button.secondary:hover {
      background-color: #555;
    }
    
    button.danger {
      background-color: #ff4757;
    }
    
    button.danger:hover {
      background-color: #e84141;
    }
    
    .preview-container {
      position: relative;
      margin-top: 20px;
    }
    
    .preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: var(--darker-bg);
      border-top-left-radius: 8px;
      border-top-right-radius: 8px;
      border-bottom: 1px solid var(--border-color);
    }
    
    iframe {
      width: 100%;
      height: 400px;
      border: none;
      background: white;
      border-bottom-left-radius: 8px;
      border-bottom-right-radius: 8px;
    }
    
    .resize-handle {
      height: 5px;
      background: var(--border-color);
      cursor: row-resize;
      margin: 5px 0;
    }
    
    .status-bar {
      background: var(--darker-bg);
      padding: 8px 15px;
      font-size: 12px;
      color: #aaa;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
    }
    
    .auto-run-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #555;
      transition: .4s;
      border-radius: 24px;
    }
    
    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .slider {
      background-color: var(--primary-color);
    }
    
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    
    @media (max-width: 768px) {
      .editor {
        flex-direction: column;
      }
      
      .codebox {
        width: 100%;
      }
      
      iframe {
        height: 300px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-code"></i>
        <h2>Live HTML/CSS/JS Editor</h2>
      </div>
      <div class="auto-run-toggle">
        <span>Auto-run</span>
        <label class="toggle-switch">
          <input type="checkbox" id="autoRunToggle" checked>
          <span class="slider"></span>
        </label>
      </div>
    </header>

    <div style="margin-bottom: 10px;">
      <span>
        Welcome, {{ current_user.username }}
        |
        <a href="{{ url_for('logout') }}" style="
          color: #fff;
          background: linear-gradient(90deg, #4d6bff 60%, #6b47ff 100%);
          padding: 6px 16px;
          border-radius: 6px;
          text-decoration: none;
          font-weight: 500;
          margin-left: 8px;
          transition: background 0.2s, color 0.2s;
          box-shadow: 0 2px 8px rgba(77,107,255,0.08);
          display: inline-block;
        " onmouseover="this.style.background='#fff';this.style.color='#4d6bff';"
          onmouseout="this.style.background='linear-gradient(90deg, #4d6bff 60%, #6b47ff 100%)';this.style.color='#fff';">
          <i class="fas fa-sign-out-alt"></i> Logout
        </a>
      </span>
    </div>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul style="color: #ff6b6b;">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}

    <form method="POST" style="margin-bottom: 0;">
      <div class="editor">
        <div class="codebox">
          <div class="codebox-header">
            <h4 class="codebox-title"><i class="fab fa-html5"></i> HTML</h4>
            <button class="secondary" type="button" onclick="insertHTMLTemplate()"><i class="fas fa-plus"></i> Template</button>
          </div>
          <textarea id="htmlEditor" name="html">{{ project.html_code if project else '' }}</textarea>
        </div>
        <div class="codebox">
          <div class="codebox-header">
            <h4 class="codebox-title"><i class="fab fa-css3-alt"></i> CSS</h4>
            <button class="secondary" type="button" onclick="insertCSSTemplate()"><i class="fas fa-plus"></i> Template</button>
          </div>
          <textarea id="cssEditor" name="css">{{ project.css_code if project else '' }}</textarea>
        </div>
        <div class="codebox">
          <div class="codebox-header">
            <h4 class="codebox-title"><i class="fab fa-js"></i> JavaScript</h4>
            <button class="secondary" type="button" onclick="insertJSTemplate()"><i class="fas fa-plus"></i> Template</button>
          </div>
          <textarea id="jsEditor" name="js">{{ project.js_code if project else '' }}</textarea>
        </div>
      </div>
      <div class="button-group">
        <button type="button" onclick="runCode()"><i class="fas fa-play"></i> Run Code</button>
        <button type="button" onclick="saveToLocal()"><i class="fas fa-save"></i> Save Code</button>
        <button type="button" onclick="downloadCode()"><i class="fas fa-download"></i> Download Code</button>
        <button class="secondary" type="button" onclick="clearEditors()"><i class="fas fa-trash"></i> Clear All</button>
        <button class="secondary" type="button" onclick="loadSample()"><i class="fas fa-lightbulb"></i> Load Sample</button>
        <button type="submit"><i class="fas fa-cloud"></i> Save Project</button>
      </div>
    </form>

    <div class="preview-container">
      <div class="preview-header">
        <h4 class="codebox-title"><i class="fas fa-eye"></i> Preview</h4>
        <div>
          <button class="secondary" onclick="refreshPreview()"><i class="fas fa-sync-alt"></i> Refresh</button>
        </div>
      </div>
      <iframe id="preview"></iframe>
    </div>

    <div class="status-bar">
      <div id="statusMessage">Ready</div>
      <div>Last saved: <span id="lastSaved">Never</span></div>
    </div>
  </div>

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/show-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/html-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/css-hint.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/hint/javascript-hint.min.js"></script>

  <script>
    // Initialize editors with more options
    const htmlEditor = CodeMirror.fromTextArea(document.getElementById("htmlEditor"), {
      mode: "xml",
      theme: "dracula",
      lineNumbers: true,
      lineWrapping: true,
      autoCloseTags: true,
      extraKeys: {"Ctrl-Space": "autocomplete"}
    });

    const cssEditor = CodeMirror.fromTextArea(document.getElementById("cssEditor"), {
      mode: "css",
      theme: "dracula",
      lineNumbers: true,
      lineWrapping: true,
      extraKeys: {"Ctrl-Space": "autocomplete"}
    });

    const jsEditor = CodeMirror.fromTextArea(document.getElementById("jsEditor"), {
      mode: "javascript",
      theme: "dracula",
      lineNumbers: true,
      lineWrapping: true,
      extraKeys: {"Ctrl-Space": "autocomplete"}
    });

    // Auto-run functionality
    const autoRunToggle = document.getElementById("autoRunToggle");
    let autoRunEnabled = true;

    autoRunToggle.addEventListener("change", function() {
      autoRunEnabled = this.checked;
      updateStatus(autoRunEnabled ? "Auto-run enabled" : "Auto-run disabled");
    });

    // Combine and display code in iframe
    function runCode() {
      try {
        const html = htmlEditor.getValue();
        const css = `<style>${cssEditor.getValue()}</style>`;
        const js = `<script>${jsEditor.getValue()}<\/script>`;
        const output = html + css + js;

        const iframe = document.getElementById("preview");
        iframe.srcdoc = output;
        
        updateStatus("Code executed successfully");
      } catch (error) {
        updateStatus("Error executing code: " + error.message, true);
      }
    }

    // Save to localStorage
    function saveToLocal() {
      try {
        localStorage.setItem("html", htmlEditor.getValue());
        localStorage.setItem("css", cssEditor.getValue());
        localStorage.setItem("js", jsEditor.getValue());
        
        const now = new Date();
        document.getElementById("lastSaved").textContent = now.toLocaleString();
        updateStatus("Code saved to browser storage");
      } catch (error) {
        updateStatus("Error saving code: " + error.message, true);
      }
    }

    // Load from localStorage
    function loadFromLocal() {
      try {
        htmlEditor.setValue(localStorage.getItem("html") || "");
        cssEditor.setValue(localStorage.getItem("css") || "");
        jsEditor.setValue(localStorage.getItem("js") || "");
        updateStatus("Previous code loaded");
      } catch (error) {
        updateStatus("Error loading saved code: " + error.message, true);
      }
    }

    // Download code as HTML file
    function downloadCode() {
      try {
        const html = htmlEditor.getValue();
        const css = `<style>${cssEditor.getValue()}</style>`;
        const js = `<script>${jsEditor.getValue()}<\/script>`;
        const blob = new Blob([html + css + js], { type: "text/html" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "code_" + new Date().toISOString().slice(0, 10) + ".html";
        link.click();
        updateStatus("Code downloaded");
      } catch (error) {
        updateStatus("Error downloading code: " + error.message, true);
      }
    }

    // Clear all editors
    function clearEditors() {
      if (confirm("Are you sure you want to clear all editors?")) {
        htmlEditor.setValue("");
        cssEditor.setValue("");
        jsEditor.setValue("");
        updateStatus("All editors cleared");
      }
    }

    // Refresh preview
    function refreshPreview() {
      runCode();
      updateStatus("Preview refreshed");
    }

    // Update status message
    function updateStatus(message, isError = false) {
      const statusElement = document.getElementById("statusMessage");
      statusElement.textContent = message;
      statusElement.style.color = isError ? "#ff6b6b" : "#aaa";
    }

    // Insert templates
    function insertHTMLTemplate() {
      htmlEditor.setValue(`<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Page</title>
</head>
<body>
  <h1>Hello World!</h1>
  <p>Start editing your HTML here</p>
</body>
</html>`);
      updateStatus("HTML template inserted");
    }

    function insertCSSTemplate() {
      cssEditor.setValue(`body {
  font-family: Arial, sans-serif;
  line-height: 1.6;
  margin: 0;
  padding: 20px;
  color: #333;
}

h1 {
  color: #4d6bff;
}`);
      updateStatus("CSS template inserted");
    }

    function insertJSTemplate() {
      jsEditor.setValue(`// JavaScript code goes here
document.addEventListener('DOMContentLoaded', function() {
  console.log('Page loaded');
  
  // Your code here
});`);
      updateStatus("JavaScript template inserted");
    }

    // Load sample project
    function loadSample() {
      if (confirm("Load sample project? This will replace your current code.")) {
        insertHTMLTemplate();
        insertCSSTemplate();
        insertJSTemplate();
        updateStatus("Sample project loaded");
      }
    }

    // Auto-run when editors change if enabled
    function setupAutoRun() {
      const editors = [htmlEditor, cssEditor, jsEditor];
      editors.forEach(editor => {
        editor.on("change", () => {
          if (autoRunEnabled) {
            runCode();
          }
        });
      });
    }

    // Initialize
    function init() {
      loadFromLocal();
      runCode();
      setupAutoRun();
      
      // Set last saved time if available
      if (localStorage.getItem("html") !== null) {
        document.getElementById("lastSaved").textContent = "Just now";
      }
    }

    init();

  </script>
</body>
</html>